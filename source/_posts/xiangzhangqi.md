---
title: 「香樟祺」小程序 - 项目 Review
keywords: Review
thumbnail: 'https://wzb-img-base.oss-cn-shanghai.aliyuncs.com/img/xzqsafhjasoin.png'
tags: Review
categories:
  - Review
date: 2020-05-12 02:44:56
---

「香樟祺」是南昌大学在新冠疫情期间使用的健康填报小程序，服务50000+师生，每日 PV 13 万左右。

<!-- MORE -->

## 需求背景

2020 年，新型冠状病毒爆发，打破了原本平静的生活。还在寒假的我们在 2 月 15 日接到了学校学工处的需求，需要开发一个每日健康报送的小程序。

大概就是让学生每日在小程序中填写表单，辅导员端能看到各班填报情况。当时想着，挺简单的啊，不就一个表单一个小后台吗？大家连夜腾讯会议开会讨论需求与技术细节，一直到次日 2 点。没错，家园人就是这么肝。

## 技术选型

因为是做微信小程序，我们主要是 React 开发者，所以选择使用 [TaroJS](http://taro-docs.jd.com/) 作为解决方案。

Taro 是一套遵循 React 语法规范的 **多端开发** 解决方案。不过很多 React 的一些特性它都不支持，而且还有很多小问题。坑也比较多。后文会提到

UI 框架选用的是 Taro UI。这个 UI 框架也有坑。

另外一个比较重要的方面。因为项目初期接到的需求比较简单，想试试微信的小程序 Serverless 云开发。就用上了。（现在觉得这是本项目问题最大的地方。。）

最后定下来的技术栈就是：TaroJS & Taro UI + 云开发



## 项目图片

<img src="https://wzb-img-base.oss-cn-shanghai.aliyuncs.com/img/20200512004112.png" style="zoom: 50%;" />

## 开发中遇到的问题

在这个项目中，我遇到的主要问题有以下几个。

### 时间戳问题

在学生提交表单时，需要记录表单提交时刻的时间戳。大学生分布在世界各地，时区不同，需要注意时间国际化。

而微信小程序开发有一个坑，在客户端获取的事件时用户设备的事件，而云函数时间为 UTC 时间。由于一开始没有考虑到这个问题，导致多个开发人员在处理时间上，有的人写 + 8 h 的代码，有人写 - 8 h ，最后都乱套了。

最后采取的方案是，统一使用 getTimestamp 云函数获取时间。进行了代码重构。之后时间问题再也没出现。

### TaroJS

TaroJS 小问题比较多：

+ 有时候代码写着写着就内存栈溢出。重新 `yarn dev:weapp` 又好了
+ 有时候代码更新之后，小程序所有样式丢失。重新 `yarn dev:weapp` 它又好了
+ 有时候代码莫名其妙报错，检查半天没问题。最后无奈重新 `yarn dev:weapp` 它又好了？

好的，得出结论 ~~重启可以解决一切问题~~ 😊

除此之外，很多 React 的特性用不了，不过一般都可以找到替代方案。

另外一个就是 @tarojs/mobx 不支持对 React 函数组件进行 inject ... 不过本项目用的是 Redux。

### Taro UI

+ TaroUI 在编译时会几率性地出现样式引入问题。
  + 这里有同样问题的 [issue](https://github.com/NervJS/taro-ui/issues/960)。不过至今还没解决，似乎涉及到 AST 解析等问题，而且这个错误是概率性的，还无法复现。Maintainer 也是这么说的。
  + 先刨个坑，之后有时间再来研究。

+ 另一个是 Taro UI 提供的 AtTabBar 底部的 padding 不够宽

###  辅导员端 Tab 性能优化

辅导员端有这么一个页面，几个 Tab 对应着班级，班级下就是学生的填报情况。这里会涉及大对象数组的查询与变化。

<img src="https://wzb-img-base.oss-cn-shanghai.aliyuncs.com/img/IMG_20200512_024230.png" style="zoom: 50%;" />

原本这个页面每切换一个 Tab 都要卡 Loading 等好久，有时候甚至直接获取不到数据。优化过后，切换流畅。

这个问题的原因有以下几点：

+ 请求的数据较多，需要等待时间
+ 辅导员频繁切换 Tab 导致多次请求
+ 云函数执行效率问题
+ 数据库查询速度

解决方案：

+ 加快数据库查询速度：
  + 一个辅导员会带很多学生，有的辅导员甚至有 200 + 的学生。然而微信小程序数据库一次查询只能返回200条数据，查更多的数据只能多次查询了。（这个没办法解决）
  + 这个性能问题是上线几天之后才出现的，思考是不是数据量增加导致查询变慢？因此添加了数据库索引，查询。
+ 减少请求的数据量：
  + 本页面只需要展示未填报与问题学生的名字。正常学生一般都是占大多数。因此，请求只需要返回问题学生与未填报学生的学号与姓名。多余的数据不要返回。
+ 减少请求次数（主要优化点）：
  + 这个问题的主要原因就是辅导员频繁切换 Tab 导致重复请求。
  + 节流：本页面会访问在全校学生数据库中进行查询，实时性要求不是特别高。基于这个背景，我们给 Tab 切换做了节流。
  + 数据缓存：每次请求将数据存在，wxStorage 中。刚打开页面时，首先展示缓存的数据，因为辅导员在催填报的时候，打开这个页面是很频繁的😂，所以这里的缓存都是比较近的数据。请求拿到数据之后才更新数据。
  + 请求超时处理：已经做了节流，此时在单位时间内函数只会触发一次，但如果函数请求失败了怎么办？我们采用的方法是重新请求，有 2 次 retry 机会，并且期间间隔 3s 。若是都失败，则不再请求，使用缓存数据。

### 需求千变万化

前面说到，刚刚接到的需求比较简单清楚。

项目上线之后，学校挺重视这个小程序，要全面推广。也就意味着，需求方变成了各个学院、学部。我们接入了研究生的学生账号、为留学生做了国际化、做了每小时全校疫情数据公示等等。

后来需要后台导出这样那样的 Excel...一言难尽，让原本就不太好用的云数据库雪上加霜。

还有各种几小时就要上线的需求。。

### 云开发的问题

第一次使用微信小程序云开发，总体来说，体验一般。

云开发的确贯彻了 NoOps 思想，运维成本变成了 0 。但也带来了一些问题。

+ 云函数代码不能很好地复用。

  + 什么？你说云函数之间可以相互调用？调用同一个云函数不就复用了吗？

  + 可是一些小的 JS 工具函数，难道还要专门做一个云函数去调用吗？那岂不是云函数调用代码比工具函数代码还多。

    <img src="https://wzb-img-base.oss-cn-shanghai.aliyuncs.com/img/20200512020321.png" style="zoom: 50%;" />

    这段代码在几个云函数中都被复制粘贴了。。。

+ 云函数云端测试功能 超级超级超级超级慢🐌

  + 测试 getTimestamp 函数，就返回一个 时间戳，也要等好几秒。🐂
+ 云函数会该偶然性地 500

+ 过一会就好了... 反正我啥也没改

+ 还有其他问题欢迎补充

## 保证服务稳定

本小程序服务全校，使用范围广、使用频率高，直接与学生是否能返校挂钩。因此，服务的稳定性至关重要。为了保证服务的稳定，我们做了以下几点。

+ 交叉 Code Review

  + 基于 GitFlow 开发，分支开发完毕后，需要 assign 给另一位同学 Code Review 通过之后。才能合并 dev

+ 可配置的参数存云数据库

  + 可能需要变动的、可能会导致问题的参数，放在数据库中。（即使是建一个数据库就存两个值。）

    因为小程序的发版是需要审核时间的，审核不通过还可能打回。放在云数据库中进行的修改能立刻生效。

+ 内部发版测试后再上线

  + 新版发布需要经过内部数十名同学的各种手机测试，业务逻辑与用户体验都通过之后，才发版上线。

+ 打好 log

  + 云函数打好关键信息的 log，以便问题出现时定位错误。

> 由于是小程序，限制诸多。如果是 Web 应用，还可以进行 TDD、灰度推送、错误监控、快速回滚等。

## 项目数据

截至目前，香樟祺日 PV 13 万左右，累计用户 5.1 万。

<img src="/Users/wzb/Library/Application Support/typora-user-images/image-20200512023713529.png" style="zoom: 33%;" />

<img src="https://wzb-img-base.oss-cn-shanghai.aliyuncs.com/img/Screenshot_2020-05-12-02-36-50-142_com.tencent.mm.jpg" style="zoom:33%;" />

## 总结

这次项目复杂度一般，各种「动态需求」把我们绕得团团转。不过服务一直也都挺稳定的，现在开学了在学校也会听到好多人在聊这个小程序，挺开心的。

